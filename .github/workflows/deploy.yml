name: Deploy Enterprise Lab

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ‡πÄ‡∏ä‡πá‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏∂‡πâ‡∏ô Server (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
      - name: Copy files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,Dockerfile,package.json,server.js"
          target: "/home/ubuntu/enterprise-lab"

      # 3. SSH ‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô (Build & Run & Clean)
      - name: Deploy on AWS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/enterprise-lab
            
            # ‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            docker-compose down || true
            
            # Build ‡πÅ‡∏•‡∏∞ Run ‡πÉ‡∏´‡∏°‡πà
            docker-compose up -d --build
            
            # üßπ Big Cleaning: ‡∏•‡∏ö Image ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
            docker image prune -f